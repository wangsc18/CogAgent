<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Core Agent Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='chart.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <style>
        /* 页面布局和基本样式 */
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .app-layout { display: flex; height: 100vh; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: #f4f7f9; }
        #dashboard-container { display: flex; gap: 2vw; padding: 2vw; border-bottom: 1px solid #e0e0e0; background-color: white; height: 20vh; min-height: 160px; }
        .chart-card { min-width: 0; background-color: white; padding: 2vw; border-radius: 0.8vw; box-shadow: 0 0.4vw 0.6vw rgba(0,0,0,0.05); display: flex; flex-direction: column; min-height: 0; }
        .chart-title { font-size: 1.2em; font-weight: 600; margin-bottom: 1vw; color: #333; flex-shrink: 0; }
        .chart-placeholder { flex-grow: 1; position: relative; height: 80%; }

        /* 聊天界面样式 */
        .chat-interface-container { position: relative; display: flex; flex-direction: column; flex-grow: 1; height: 0; }
        .conversation-log { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .message-row { display: flex; margin-bottom: 12px; }
        .user-row { justify-content: flex-end; }
        .system-row { justify-content: center; } /* System messages centered */
        .reactive_agent-row, .proactive_agent-row { justify-content: flex-start; }
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; line-height: 1.5; word-wrap: break-word; }
        .user-bubble { background-color: #007bff; color: white; border-bottom-right-radius: 4px; }
        .reactive_agent-bubble { background-color: #f1f0f0; color: black; border-bottom-left-radius: 4px; }
        .proactive_agent-bubble { background-color: #e6f7ff; color: #0056b3; border: 1px solid #91d5ff; font-size: 14px; }
        .system-bubble { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; font-size: 13px; font-style: italic; text-align: center; }
        
        /* 输入区域 */
        .input-area-container { padding: 15px 20px; border-top: 1px solid #e0e0e0; background-color: white; }
        .input-elements-wrapper { display: flex; align-items: center; gap: 10px; }
        #command-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; resize: none; font-size: 16px; }
        #send-button, #file-upload-button { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; }
        .send-icon { width: 24px; height: 24px; color: #007bff; }
        .upload-icon { width: 22px; height: 22px; color: #6c757d; }
        #file-upload-status { font-size: 12px; color: #007bff; margin-top: 5px; height: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .footer-text { font-size: 12px; color: #aaa; text-align: center; margin-top: 10px; }

        /* 确认横幅 */
        .confirmation-banner { padding: 12px; background-color: #e6f7ff; border-top: 1px solid #91d5ff; text-align: center; position: sticky; bottom: 100px; z-index: 100; }
        .confirmation-banner.hidden { display: none; }
        .confirmation-banner button { margin-left: 15px; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #confirm-yes { background-color: #28a745; color: white; border: none; }
        #confirm-no { background-color: #dc3545; color: white; border: none; }

        /* 顶部按钮 */
        #new-chat-button { position: absolute; top: 15px; left: 20px; z-index: 10; padding: 8px 15px; font-size: 14px; font-weight: bold; color: #007bff; background-color: white; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #new-chat-button:hover { background-color: #007bff; color: white; border-color: #007bff; }
        #manual-assist-button { position: absolute; top: 15px; right: 20px; z-index: 10; padding: 8px; color: #6c757d; background-color: white; border: 1px solid #dee2e6; border-radius: 50%; cursor: pointer; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #manual-assist-button:hover { color: #dc3545; border-color: #dc3545; }
        .help-icon { width: 24px; height: 24px; }

        /* 消息内元素 */
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 1.1em; /* 使用相对大小 */
        }
        .message-bubble img { max-width: 100%; border-radius: 10px; margin-top: 8px; }
        .attachment-info { color: #a9a9a9 !important; font-style: italic; font-size: 0.9em; display: block; margin-top: 5px; }
        
        .chart-card:first-child {
            flex-basis: 65%;
            flex-grow: 1;
            max-width: 50vw;
        }
        .chart-card:last-child {
            flex-basis: 35%;
            flex-shrink: 0;
            max-width: 50vw;
        }

        .message-bubble code { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 0.9em; background-color: #e9ecef; padding: 0.2vw 0.5vw; border-radius: 0.4vw; }
        .message-bubble pre { background-color: #282c34; color: #abb2bf; padding: 1.5vw; border-radius: 0.8vw; margin-top: 1vw; margin-bottom: 0.5vw; overflow-x: auto; white-space: pre; }
        .message-bubble pre code { background-color: transparent; padding: 0; color: inherit; }

    </style>
</head>
<body>
    <div class="app-layout">
        <main class="main-content">
            <div id="dashboard-container" class="dashboard-container">
                <div class="chart-card">
                    <div class="chart-title">用户认知负荷变化</div>
                    <div class="chart-placeholder">
                        <canvas id="cognitiveLoadChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">会话认知负荷分布</div>
                    <div class="chart-placeholder">
                        <canvas id="cognitiveLoadDistributionChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="chat-interface-container">
                <button id="new-chat-button">⊕ 新建对话</button>
                <button id="manual-assist-button" title="需要帮助">
                    <svg class="help-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="conversation-log" class="conversation-log"></div>
                <div id="confirmation-banner" class="confirmation-banner hidden">
                    <span id="confirmation-text"></span>
                    <button id="confirm-yes">是的，请帮助我</button>
                    <button id="confirm-no">不了，谢谢</button>
                </div>
                <div class="input-area-container">
                    <div class="input-elements-wrapper">
                        <button id="file-upload-button" type="button" aria-label="Attach file">
                            <svg class="upload-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22">
                                <path d="M924.672 126.976q36.864 36.864 54.784 82.432t17.92 93.696-17.92 93.696-54.784 82.432l-392.192 389.12q-36.864 36.864-90.624 61.44t-113.664 28.672-122.368-16.384-115.712-73.728q-52.224-52.224-72.704-113.152t-16.384-121.344 28.16-113.664 60.928-90.112l348.16-345.088q9.216-9.216 27.136-4.608t27.136 13.824q8.192 9.216 13.312 27.136t-4.096 27.136l-347.136 344.064q-27.648 27.648-46.08 64.512t-21.504 78.848 12.288 84.992 55.296 82.944q35.84 35.84 79.36 50.688t86.528 12.288 81.92-18.944 66.56-44.032l391.168-388.096q27.648-27.648 39.424-57.344t11.264-58.88-13.824-56.832-36.864-51.2q-44.032-43.008-98.816-40.448t-110.08 57.856l-353.28 351.232q-23.552 23.552-23.04 52.224t18.944 47.104q22.528 22.528 51.712 18.432t47.616-22.528l320.512-318.464q9.216-9.216 27.136-4.608t27.136 13.824 14.336 27.136-4.096 27.136l-321.536 318.464q-36.864 36.864-70.656 51.2t-63.488 12.8-55.296-15.872-47.104-34.816q-17.408-16.384-31.232-41.984t-15.872-56.32 10.752-65.536 49.664-70.656q18.432-18.432 32.768-33.792 12.288-13.312 23.04-23.552t11.776-11.264l285.696-284.672q36.864-36.864 80.384-57.856t88.576-24.064 88.576 12.288 80.384 52.224z"></path>
                            </svg>
                        </button>
                        <input type="file" id="file-input" style="display: none;">
                        <div class="main-input-group" style="flex-grow: 1;">
                            <textarea id="command-input" placeholder="输入消息，或点击左侧回形针上传文件..." rows="1"></textarea>
                        </div>
                        <button id="send-button" aria-label="Send message">
                            <svg class="send-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#007bff">
                                <path d="M664.88260888 860.06521777a50.98695644 50.98695644 0 0 0 77.1652169-28.79999999l189.86087021-670.89130489A71.17826045 71.17826045 0 0 0 883.26956533 72.56521777a70.55217422 70.55217422 0 0 0-49.06956533 3.75652178L119.13043467 406.34782578a51.26086934 51.26086934 0 0 0-6.73043467 89.3347831l149.24347822 98.41304356a31.30434756 31.30434756 0 1 0 34.43478223-52.27826132l-132.18260801-87.1826089 696.52173868-321.45652177a7.94347822 7.94347822 0 0 1 5.55652177-0.43043467 8.56956533 8.56956533 0 0 1 5.67391289 10.56521777L686.13043467 799.1l-132.45652178-87.37826045a39.13043467 39.13043467 0 0 0-53.53043466 10.09565157l-72.46956534 102.52173954v-205.70869599l274.38260889-226.09565244a31.30434756 31.30434756 0 1 0-39.79565244-48.32608624l-282.91304356 233.13912979a39.13043467 39.13043467 0 0 0-14.282608 30.20869599v290.73913067a39.13043467 39.13043467 0 0 0 71.09999999 22.53912979l102.01304268-144.35217335 126.7434791 83.62173868z"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="file-upload-status"></div>
                    <div class="footer-text">Agent can make mistakes. Consider checking important information.</div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // --- 获取页面元素 ---
            const conversationLog = document.getElementById("conversation-log");
            const commandInput = document.getElementById("command-input");
            const sendButton = document.getElementById("send-button");
            const confirmationBanner = document.getElementById("confirmation-banner");
            const confirmationText = document.getElementById("confirmation-text");
            const confirmYesBtn = document.getElementById("confirm-yes");
            const confirmNoBtn = document.getElementById("confirm-no");
            const newChatButton = document.getElementById("new-chat-button");
            const manualAssistButton = document.getElementById("manual-assist-button");
            const fileInput = document.getElementById("file-input");
            const fileUploadStatus = document.getElementById("file-upload-status");
            const fileUploadButton = document.getElementById("file-upload-button");
            
            // --- 会话ID管理 ---
            let sessionId = localStorage.getItem('agentSessionId');
            if (!sessionId) {
                sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('agentSessionId', sessionId);
            }
            console.log("Using session ID:", sessionId);

            let currentAssistanceRequestId = null;
            let inquiryTimeoutId = null;
            let attachedFile = null;

            // --- 辅助函数 ---
            function escapeHtml(text) { const div = document.createElement("div"); div.textContent = text; return div.innerHTML; }
            function adjustTextareaHeight() { if (!commandInput) return; commandInput.style.height = "auto"; const maxHeight = parseFloat(getComputedStyle(commandInput).lineHeight) * 4; commandInput.style.height = Math.min(commandInput.scrollHeight, maxHeight) + "px"; commandInput.style.overflowY = (commandInput.scrollHeight > maxHeight) ? "auto" : "hidden"; }
            function appendMessage(sender, textContent, imageUrl = null, attachmentInfo = null) {
                const senderClass = sender === "You" ? "user" : (sender.startsWith("Agent (Proactive)") ? "proactive_agent" : "reactive_agent");
                
                const messageRow = document.createElement("div");
                messageRow.classList.add("message-row", senderClass + "-row");
                const messageBubble = document.createElement("div");
                messageBubble.classList.add("message-bubble", senderClass + "-bubble");

                const senderStrong = document.createElement("strong");
                senderStrong.textContent = sender + ": ";
                messageBubble.appendChild(senderStrong);

                // 创建一个临时的 div 来容纳解析后的 HTML 内容
                const contentContainer = document.createElement('div');
                contentContainer.style.display = 'inline'; // 让它像 span 一样，不影响布局

                const dirtyHtml = marked.parse(textContent, { breaks: true, gfm: true }); // breaks: true 让换行符变成 <br>, gfm: true 启用GitHub风格的Markdown
                contentContainer.innerHTML = dirtyHtml;
                messageBubble.appendChild(contentContainer);

                // --- 新增逻辑：独立渲染附件信息 ---
                if (attachmentInfo && attachmentInfo.name) {
                    const attachmentSpan = document.createElement("span");
                    attachmentSpan.className = "attachment-info"; // 使用你已经定义好的CSS类
                    attachmentSpan.textContent = `(已附加文件: ${escapeHtml(attachmentInfo.name)})`;
                    messageBubble.appendChild(attachmentSpan);
                }

                if (imageUrl) {
                    const imgPreview = document.createElement("img");
                    imgPreview.src = imageUrl;
                    messageBubble.appendChild(imgPreview);
                }

                messageRow.appendChild(messageBubble);
                conversationLog.appendChild(messageRow);
                conversationLog.scrollTop = conversationLog.scrollHeight;
            }

            // --- 3. 图表初始化和更新逻辑 ---
            const CHART_DATA_LIMIT = 10;
            let cognitiveLoadCounts = { low: 0, medium: 0, high: 0 };

            // --- 1. 初始化折线图 ---
            const ctxLine = document.getElementById('cognitiveLoadChart').getContext('2d');
            const lineChartData = {
                labels: [],
                datasets: [
                    { label: '认知负荷', data: [], borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)', yAxisID: 'y_load', tension: 0.3 },
                    { label: '键盘频率 (Hz)', data: [], borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)', yAxisID: 'y1', tension: 0.3 },
                    { label: '鼠标频率 (Hz)', data: [], borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.5)', yAxisID: 'y1', tension: 0.3 }
                ]
            };
            const cognitiveLoadChart = new Chart(ctxLine, {
                type: 'line',
                data: lineChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // 这是让图表填充容器的关键！
                    scales: {
                        y_load: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '认知负荷' },
                            min: 0,
                            max: 2,
                            ticks: {
                                stepSize: 1,
                                autoSkip: false,
                                precision: 0,
                                callback: function(value) {
                                    const labels = { 0: '低', 1: '中', 2: '高' };
                                    return labels[value] !== undefined ? labels[value] : value;
                                }
                            },
                            grid: {
                                drawTicks: true,
                                color: '#e0e0e0'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: '频率 (Hz)' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    animation: { duration: 500 }
                }
            });

            // --- 2. 认知负荷分布扇形图 ---
            const ctxPie = document.getElementById('cognitiveLoadDistributionChart').getContext('2d');
            const pieChartData = {
                labels: ['Low', 'Medium', 'High'],
                datasets: [{
                    label: '认知负荷次数',
                    // 初始数据从我们的累积状态变量中获取
                    data: [cognitiveLoadCounts.low, cognitiveLoadCounts.medium, cognitiveLoadCounts.high], 
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.7)',  // 绿色，代表轻松
                        'rgba(255, 206, 86, 0.7)',  // 黄色，代表中等
                        'rgba(255, 99, 132, 0.7)'   // 红色，代表高负荷
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1,
                    hoverOffset: 8
                }]
            };
            // 将图表实例存储在变量中，以便后续更新
            const cognitiveLoadPieChart = new Chart(ctxPie, {
                type: 'pie', // 类型改为 pie
                data: pieChartData,
                options: {
                    responsive: true,
                    // maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.raw;
                                    const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0%';
                                    return `${label}${value} 次 (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });

            function updateCognitiveLoadChart(dataPoint) {

                // 更新折线图
                let loadValue = 0; // 默认为“低”
                if (dataPoint.cognitive_load === 'Medium Load') {
                    loadValue = 1;
                } else if (dataPoint.cognitive_load === 'High Load') {
                    loadValue = 2;
                }
                lineChartData.labels.push(dataPoint.timestamp);
                lineChartData.datasets[0].data.push(loadValue);
                lineChartData.datasets[1].data.push(dataPoint.keyboard);
                lineChartData.datasets[2].data.push(dataPoint.mouse);
                if (lineChartData.labels.length > CHART_DATA_LIMIT) {
                    lineChartData.labels.shift();
                    lineChartData.datasets.forEach(dataset => { dataset.data.shift(); });
                }
                cognitiveLoadChart.update();

                // 更新扇形图
                if (dataPoint.cognitive_load === 'High Load') {
                    cognitiveLoadCounts.high++;
                } else if (dataPoint.cognitive_load === 'Medium Load') {
                    cognitiveLoadCounts.medium++;
                } else { // 默认为 'Low Load'
                    cognitiveLoadCounts.low++;
                }
                // 将新的计数值更新到扇形图的数据对象中
                pieChartData.datasets[0].data = [
                    cognitiveLoadCounts.low,
                    cognitiveLoadCounts.medium,
                    cognitiveLoadCounts.high
                ];
                cognitiveLoadPieChart.update();
            }

            // --- 文件上传功能 ---
            fileUploadButton.addEventListener("click", () => fileInput.click());

            fileInput.addEventListener("change", function(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    attachedFile = {
                        name: file.name,
                        content: e.target.result.split(',')[1],
                        type: "document" // 标记为文档类型
                    };
                    fileUploadStatus.textContent = `已附加: ${file.name}`;
                };
                reader.onerror = function() {
                    fileUploadStatus.textContent = "读取文件出错";
                    attachedFile = null;
                };
                reader.readAsDataURL(file);
            });

            // --- 监听输入框的粘贴事件 ---
            commandInput.addEventListener("paste", function(event) {
                // 检查剪贴板中的项目
                const items = (event.clipboardData || window.clipboardData).items;
                for (let i = 0; i < items.length; i++) {
                    // 如果项目是文件且类型是图片
                    if (items[i].kind === 'file' && items[i].type.indexOf('image') !== -1) {
                        // 阻止默认的粘贴行为 (例如，在某些浏览器中会粘贴文件路径)
                        event.preventDefault();
                        
                        const file = items[i].getAsFile();
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            // 将图片数据存储为 Base64，并准备发送
                            attachedFile = {
                                name: "Pasted Image.png", // 给它一个通用的名字
                                content: e.target.result.split(',')[1],
                                type: "image", // 添加一个类型提示
                                previewUrl: e.target.result // 完整的 Data URL 用于预览
                            };
                            
                            // 显示状态，并清空输入框，准备发送
                            fileUploadStatus.textContent = `已附加粘贴的图片。`;
                            commandInput.value = ""; // 清空文本，因为图片是主要内容
                            console.log("Image pasted and attached.");
                        };
                        reader.readAsDataURL(file);
                        
                        // 只处理第一张图片
                        return;
                    }
                }
            });

            // --- 核心功能：发送用户输入的消息 ---
            async function sendMessage() {
                const userInput = commandInput.value.trim();
                // 只有当有文本或有附件时才发送
                if (userInput === "" && !attachedFile) return;

                // 检查是否是结束会话的命令
                const isEndCommand = userInput.toLowerCase() === 'end';
                if (isEndCommand) {
                    appendMessage("System", "好的，正在为您结束当前会话并保存记忆...");
                    // ... (end chat 逻辑保持不变)
                    fetch("/end_chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ session_id: sessionId })
                    }).then(response => response.json()).then(data => {
                        console.log("End chat response:", data);
                        appendMessage("System", "记忆已开始后台保存。您可以点击左上角的“新建对话”按钮开始新的会话。");
                    }).catch(error => {
                        console.error("Error ending chat:", error);
                        appendMessage("System Error", "结束会话时发生错误: " + error.message);
                    });
                    
                    commandInput.value = "";
                    adjustTextareaHeight();
                    sendButton.disabled = true;
                    return;
                }

                // 1. 准备一个变量用于发送到后端的 payload
                let messageForPayload = userInput;

                // 2. 如果用户没有输入文本但附加了文件，则为 payload 提供一个默认指令
                if (messageForPayload === "" && attachedFile) {
                    messageForPayload = `请分析或处理这个文件：${attachedFile.name}`; // 给LLM一个明确的指令
                }

                // 如果是文档，就准备 attachmentInfo 对象，否则为 null
                const attachmentInfoForDisplay = (attachedFile && attachedFile.type === 'document') ? attachedFile : null;
                
                // 如果是图片，就准备 imageUrl，否则为 null
                const imageUrlForDisplay = (attachedFile && attachedFile.type === 'image') ? attachedFile.previewUrl : null;
                
                // 【注意】前端显示的消息仍然是用户原始的输入（空字符串），这样UI上是正确的
                appendMessage("You", userInput, imageUrlForDisplay, attachmentInfoForDisplay);


                const payload = {
                    // 【注意】发送到后端的是我们处理过的 messageForPayload
                    message: messageForPayload, 
                    session_id: sessionId
                };
                
                if (attachedFile) {
                    payload.file = {
                        name: attachedFile.name,
                        content: attachedFile.content,
                        type: attachedFile.type || "document"
                    };
                }
                
                commandInput.value = "";
                adjustTextareaHeight();
                sendButton.disabled = true;
                
                try {
                    const response = await fetch("/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || "Server error"); }
                    const data = await response.json();
                    appendMessage("Agent", data.response);
                } catch (error) {
                    appendMessage("System Error", error.message);
                } finally {
                    attachedFile = null;
                    fileInput.value = ""; 
                    fileUploadStatus.textContent = "";
                    sendButton.disabled = false;
                    commandInput.focus();
                }
            }

            // --- 核心功能：处理主动服务响应 ---
            confirmYesBtn.addEventListener("click", async function() {
                if (inquiryTimeoutId) clearTimeout(inquiryTimeoutId);
                inquiryTimeoutId = null;
                if (!currentAssistanceRequestId) return;
                confirmationBanner.classList.add("hidden");
                appendMessage("You", "是的，请帮助我。");
                try {
                    const response = await fetch("/request_assistance", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ request_id: currentAssistanceRequestId, session_id: sessionId })
                    });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error); }
                    const data = await response.json();
                    if (data.analysis_message) appendMessage("Agent (Proactive)", data.analysis_message);
                    if (data.final_response) appendMessage("Agent", data.final_response);
                } catch (error) { appendMessage("System Error", error.message); } 
                finally { currentAssistanceRequestId = null; }
            });

            confirmNoBtn.addEventListener("click", function() {
                if (inquiryTimeoutId) clearTimeout(inquiryTimeoutId);
                inquiryTimeoutId = null;
                confirmationBanner.classList.add("hidden");
                appendMessage("You", "不了，谢谢。");
                appendMessage("Agent (Proactive)", "好的，如果您需要帮助，可以随时向我提问。");
                currentAssistanceRequestId = null;
            });

            // --- 核心功能：手动求助 ---
            manualAssistButton.addEventListener("click", async function() {
                appendMessage("You", "我好像卡住了，能帮我看看吗？");
                try {
                    const response = await fetch("/manual_trigger_assistance", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error); }
                    const data = await response.json();
                    if (data.analysis_message) appendMessage("Agent (Proactive)", data.analysis_message);
                    if (data.final_response) appendMessage("Agent", data.final_response);
                } catch (error) { appendMessage("System Error", "请求帮助时发生错误: " + error.message); }
            });

            // --- 核心功能：监听来自服务器的 Server-Sent Events ---
            let sse = null; // 将 sse 声明为可变变量
            
            function connectSSE() {
                // 如果已有连接，并且状态不是CLOSED，则不重复连接
                if (sse && sse.readyState !== EventSource.CLOSED) {
                    console.log("SSE connection is already open.");
                    return;
                }

                console.log("Connecting to SSE stream at /listen ...");
                sse = new EventSource("/listen"); // 创建新的EventSource实例
                
                sse.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'state_update') {
                            updateCognitiveLoadChart(data.data);
                        } 
                        else if (data.type === 'inquiry') {
                            console.log("Received inquiry from server:", data);

                            // 1. 如果上一个询问的计时器还在，先清除它
                            if (inquiryTimeoutId) {
                                clearTimeout(inquiryTimeoutId);
                            }

                            // 2. 更新弹窗内容并显示
                            confirmationText.textContent = data.text;
                            currentAssistanceRequestId = data.request_id; 
                            confirmationBanner.classList.remove("hidden");
                            
                            // 3. 设置一个新的20秒计时器，超时后自动隐藏弹窗
                            inquiryTimeoutId = setTimeout(() => {
                                console.log("Inquiry timed out. Hiding banner.");
                                confirmationBanner.classList.add("hidden");

                                appendMessage("You", "用户无响应。");
                                appendMessage("Agent (Proactive)", "系统建议已超时，自动为您关闭。");
                                currentAssistanceRequestId = null; // 清理ID
                                inquiryTimeoutId = null; // 清理计时器ID
                            }, 20000); // 20000毫秒 = 20秒
                        }
                    } catch (e) { console.error("Error parsing SSE data:", e); }
                };
                sse.onopen = function() {
                    console.log("SSE connection established successfully.");
                };
                sse.onerror = function(error) {
                    console.error("SSE connection error:", error); 
                }; // 不能关闭sse，要让它自动重连
            }

            connectSSE();
            // 每10秒检查一次SSE连接的状态，如果发现是CLOSED，就强制重新连接
            setInterval(() => {
                if (!sse || sse.readyState === EventSource.CLOSED) {
                    console.warn("Watchdog detected a closed SSE connection. Forcing reconnect...");
                    connectSSE();
                }
            }, 10000); // 每10秒检查一次

            // --- 事件绑定 ---
            sendButton.addEventListener("click", sendMessage);
            commandInput.addEventListener("input", adjustTextareaHeight);
            commandInput.addEventListener("keydown", function(event) { if (event.key === "Enter" && !event.shiftKey) { event.preventDefault(); sendMessage(); } });
            newChatButton.addEventListener("click", function() { localStorage.removeItem('agentSessionId'); location.reload(); });
            
            adjustTextareaHeight();
        });
    </script>
</body>
</html>